<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeoGPT â€” Paneli i Adminit</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bs-body-font-family: 'Plus Jakarta Sans', sans-serif; }
    .admin-nav { background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%); }
    .card { border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-radius: 12px; }
    .card-header { font-weight: 600; border-radius: 12px 12px 0 0; }
    .ig-highlight { border-left: 4px solid #E1306C; }
    .form-check-input:checked { background-color: #1e3a5f; border-color: #1e3a5f; }
    .btn-primary { background: #1e3a5f; border-color: #1e3a5f; }
    .btn-primary:hover { background: #2d4a7c; border-color: #2d4a7c; }
    .btn-outline-danger { border-color: #dc3545; }
    .api-step { background: #f8f9fa; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
  </style>
</head>
<body class="bg-light">
  <div id="adminApp">
    <!-- Login -->
    <div id="loginView" class="d-none">
      <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
        <div class="card shadow-sm" style="max-width: 400px; width: 100%">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Paneli i Adminit</h2>
            <p class="text-danger small mb-2" id="loginErr"></p>
            <div class="mb-3">
              <input type="email" id="adminEmail" class="form-control form-control-lg" placeholder="Email" />
            </div>
            <div class="mb-3">
              <input type="password" id="adminPassword" class="form-control form-control-lg" placeholder="FjalÃ«kalimi" />
            </div>
            <button id="adminLoginBtn" class="btn btn-primary btn-lg w-100 mb-2">Hyr</button>
            <a href="index.html" class="text-decoration-none small">â† Kthehu te aplikacioni</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="d-none">
      <nav class="navbar admin-nav navbar-dark mb-4">
        <div class="container">
          <span class="navbar-brand mb-0">LeoGPT Admin</span>
          <div class="d-flex align-items-center gap-2">
            <span class="text-white-50 small" id="adminUser"></span>
            <a href="index.html" class="btn btn-sm btn-outline-light">Aplikacioni</a>
            <button class="btn btn-sm btn-outline-light" id="logoutAdmin">Dil</button>
          </div>
        </div>
      </nav>

      <div class="container pb-5">
        <!-- Geri bildirim -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">ğŸ“Š Statistikat e reagimeve</div>
          <div class="card-body">
            <div class="row g-3 mb-3">
              <div class="col-4"><div class="p-3 bg-light rounded text-center"><div class="h4 mb-0 text-primary" id="statLikes">0</div><small class="text-muted">PÃ«lqime ğŸ‘</small></div></div>
              <div class="col-4"><div class="p-3 bg-light rounded text-center"><div class="h4 mb-0 text-danger" id="statDislikes">0</div><small class="text-muted">Nuk pÃ«lqej ğŸ‘</small></div></div>
              <div class="col-4"><div class="p-3 bg-light rounded text-center"><div class="h4 mb-0" id="statTotal">0</div><small class="text-muted">Gjithsej</small></div></div>
            </div>
            <details><summary class="cursor-pointer">Reagimet e fundit</summary>
              <div class="table-responsive mt-2" style="max-height:200px"><table class="table table-sm" id="feedbackTable"><thead><tr><th>Data</th><th>Rating</th><th>PÃ«rdoruesi</th><th>Koment</th></tr></thead><tbody></tbody></table></div>
            </details>
          </div>
        </div>

        <!-- Instagram - KU KUSH SI -->
        <div class="card mb-4 ig-highlight">
          <div class="card-header bg-white py-3 d-flex align-items-center">
            <span class="me-2">ğŸ“±</span>
            <span>Instagram â€” Ku shtohen llogaritÃ«? Kush shton? Si?</span>
          </div>
          <div class="card-body">
            <div class="alert alert-info mb-3">
              <strong>Ku?</strong> KÃ«tu, nÃ« kÃ«tÃ« panel. <strong>Kush?</strong> VetÃ«m admin (ti). <strong>Si?</strong> Meta API â€” shiko hapat mÃ« poshtÃ«.
            </div>
            <div class="mb-3">
              <h6 class="text-muted mb-2">API Meta â€” Ã‡farÃ« duhet nÃ« server/.env:</h6>
              <div class="api-step"><code>META_APP_ID</code> â€” Nga developers.facebook.com â†’ Settings â†’ Basic</div>
              <div class="api-step"><code>META_APP_SECRET</code> â€” I njÃ«jti vend</div>
              <div class="api-step"><code>INSTAGRAM_REDIRECT_URI</code> â€” https://domain-i-yte/api/instagram/callback</div>
              <p class="small text-muted mt-2">Detaj: <code>INSTAGRAM-NASIL-EKLENIR.md</code> ose <code>INSTAGRAM-BASIT-REHBER.md</code></p>
            </div>
            <div id="igConfigMsg" class="alert alert-warning d-none mb-3"></div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-primary" id="igConnectBtn">+ Lidh llogari Instagram (OAuth)</button>
              <button class="btn btn-outline-secondary" id="igTokenBtn">Shto me token (nga Meta)</button>
            </div>
            <div id="igTokenForm" class="mb-3 d-none">
              <label class="form-label small">Token nga Meta â†’ Generate token (kopjo dhe ngjit kÃ«tu):</label>
              <div class="input-group">
                <input type="password" id="igTokenInput" class="form-control" placeholder="IGQA..." />
                <button class="btn btn-success" id="igTokenSubmit">Shto</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover" id="igAccountsTable">
                <thead><tr><th>@username</th><th>Shtuar mÃ«</th><th>Sync i fundit</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VeÃ§oritÃ« -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">âš™ï¸ VeÃ§oritÃ« (hap/mbyll)</div>
          <div class="card-body">
            <p class="small text-muted mb-3">KÃ«to ruhen si cilÃ«sime. Persona i pÃ«rdor ato.</p>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_voice" data-key="features_voice" type="checkbox"><label class="form-check-label">VeÃ§oritÃ« e zÃ«rit</label></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_chat" data-key="features_chat" type="checkbox"><label class="form-check-label">VeÃ§oritÃ« e bisedÃ«s</label></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_visual" data-key="features_visual" type="checkbox"><label class="form-check-label">VeÃ§oritÃ« vizuale</label></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_tech" data-key="features_tech" type="checkbox"><label class="form-check-label">MbÃ«shtetje teknike</label></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_business" data-key="features_business" type="checkbox"><label class="form-check-label">Biznes & sipÃ«rmarrje</label></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input toggle-switch" id="feat_login" data-key="require_login" type="checkbox"><label class="form-check-label">HyrÃ« e detyrueshme</label></div>
            <div class="form-check form-switch"><input class="form-check-input toggle-switch" id="feat_invite" data-key="invite_only" type="checkbox"><label class="form-check-label">Modalitet i ftuar (vetÃ«m tÃ« lejuarit regjistrohen)</label></div>
          </div>
        </div>

        <!-- Email tÃ« lejuar -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">ğŸ“§ Email tÃ« lejuar</div>
          <div class="card-body">
            <p class="small text-muted mb-3">Kur modaliteti i ftuar Ã«shtÃ« aktiv, vetÃ«m kÃ«ta email regjistrohen.</p>
            <div class="input-group mb-3">
              <input type="email" id="allowedEmailInput" class="form-control" placeholder="shembull@email.com" />
              <button class="btn btn-primary" id="addAllowedEmail">Shto</button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm" id="allowedEmailsTable"><thead><tr><th>Email</th><th>Shtuar mÃ«</th><th></th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>

        <!-- Logo -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">ğŸ–¼ Logo</div>
          <div class="card-body">
            <div class="input-group mb-2">
              <input type="text" id="logoUrl" class="form-control" placeholder="https://... ose /uploads/xxx.png" />
              <button class="btn btn-primary" id="saveLogo">Ruaj</button>
            </div>
          </div>
        </div>

        <!-- Ngarkim imazhi -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">ğŸ“¤ Ngarko imazh</div>
          <div class="card-body">
            <input type="file" id="fileUpload" class="form-control mb-2" accept="image/*" />
            <button class="btn btn-primary" id="uploadBtn">Ngarko</button>
            <p class="small mt-2 text-muted" id="uploadResult"></p>
          </div>
        </div>

        <!-- PÃ«rdoruesit -->
        <div class="card mb-4">
          <div class="card-header bg-white py-3">ğŸ‘¥ PÃ«rdoruesit</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0" id="usersTable"><thead><tr><th>ID</th><th>Email</th><th>Emri</th><th>Admin</th><th>Regjistruar</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script>
    const BACKEND = (typeof LEOHOCA_BACKEND !== 'undefined' && LEOHOCA_BACKEND) ? LEOHOCA_BACKEND.replace(/\/$/, '') : (localStorage.getItem('leohoca_backend') || (location.origin && location.origin !== 'null' ? location.origin : 'http://localhost:3100'));
    let token = localStorage.getItem('leogpt_token');

    function api(path, opts = {}) {
      return fetch(BACKEND + path, {
        ...opts,
        headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}), ...opts.headers }
      });
    }

    function showLogin() {
      document.getElementById('loginView').classList.remove('d-none');
      document.getElementById('dashboardView').classList.add('d-none');
    }

    function showDashboard() {
      document.getElementById('loginView').classList.add('d-none');
      document.getElementById('dashboardView').classList.remove('d-none');
      loadData();
    }

    async function checkAuth() {
      if (!token) { showLogin(); return; }
      try {
        const r = await api('/api/admin/check');
        const d = await r.json();
        if (d.ok && d.admin) {
          const user = JSON.parse(localStorage.getItem('leogpt_user') || '{}');
          document.getElementById('adminUser').textContent = user.email || 'Admin';
          showDashboard();
        } else showLogin();
      } catch (_) { showLogin(); }
    }

    document.getElementById('adminLoginBtn')?.addEventListener('click', async () => {
      const err = document.getElementById('loginErr');
      const btn = document.getElementById('adminLoginBtn');
      err.textContent = '';
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      if (!email || !password) { err.textContent = 'Vendosni email dhe fjalÃ«kalim'; return; }
      btn.disabled = true;
      btn.textContent = 'Duke hyrÃ«...';
      try {
        const r = await fetch(BACKEND + '/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const d = await r.json().catch(() => ({}));
        if (d.ok && d.user?.is_admin) {
          token = d.token;
          localStorage.setItem('leogpt_token', token);
          localStorage.setItem('leogpt_user', JSON.stringify(d.user));
          showDashboard();
        } else err.textContent = d.error || 'E pamundur â€” kÃ«rkohet llogari admin';
      } catch (e) { err.textContent = 'Gabim lidhjeje. A Ã«shtÃ« serveri aktiv?'; }
      btn.disabled = false;
      btn.textContent = 'Hyr';
    });

    document.getElementById('logoutAdmin')?.addEventListener('click', () => {
      localStorage.removeItem('leogpt_token');
      localStorage.removeItem('leogpt_user');
      token = null;
      showLogin();
    });

    async function handleIgCallback() {
      const params = new URLSearchParams(location.search);
      const ok = params.get('ig_ok');
      const err = params.get('ig_error');
      if (ok) { alert('Instagram u lidh: @' + ok); history.replaceState({}, '', location.pathname); return; }
      if (err) {
        let msg = 'Gabim Instagram: ' + err;
        if (err === 'code_yok') {
          msg += '\n\nKontrollo:\n1. Meta â†’ Set up Instagram business login â†’ OAuth redirect URIs: https://leohoca.up.railway.app/api/instagram/callback\n2. Meta â†’ Add account â†’ Instagram hesabÄ±nÄ± "Instagram Tester" olarak ekle\n3. Instagram sayfasÄ±nda "Ä°zin ver" butonuna tÄ±kla';
        }
        alert(msg);
        history.replaceState({}, '', location.pathname);
      }
    }

    async function loadIgAccounts() {
      const cfgRes = await api('/api/instagram/configured');
      const cfg = await cfgRes.json();
      const msgEl = document.getElementById('igConfigMsg');
      const btn = document.getElementById('igConnectBtn');
      if (!cfg.configured) {
        msgEl.classList.remove('d-none');
        msgEl.textContent = 'Shtoni META_APP_ID, META_APP_SECRET, INSTAGRAM_REDIRECT_URI nÃ« server/.env. Shiko INSTAGRAM-NASIL-EKLENIR.md';
        btn.disabled = true;
        return;
      }
      msgEl.classList.add('d-none');
      btn.disabled = false;
      btn.onclick = async () => {
        const r = await api('/api/instagram/connect');
        const d = await r.json();
        if (d.url) window.location.href = d.url;
        else alert(d.error || 'Nuk u mor lidhja');
      };
      const tokenBtn = document.getElementById('igTokenBtn');
      const tokenForm = document.getElementById('igTokenForm');
      const tokenInput = document.getElementById('igTokenInput');
      const tokenSubmit = document.getElementById('igTokenSubmit');
      if (tokenBtn) tokenBtn.onclick = () => { tokenForm.classList.toggle('d-none'); };
      if (tokenSubmit) tokenSubmit.onclick = async () => {
        const t = tokenInput?.value?.trim();
        if (!t) { alert('Vendosni tokenin'); return; }
        const r = await api('/api/admin/instagram/add-token', { method: 'POST', body: JSON.stringify({ token: t }) });
        const d = await r.json();
        if (d.ok) { alert('Instagram u lidh: @' + d.username); tokenInput.value = ''; tokenForm.classList.add('d-none'); loadIgAccounts(); }
        else alert(d.error || 'Gabim');
      };
      const r = await api('/api/admin/instagram/accounts');
      const d = await r.json();
      const tbody = document.querySelector('#igAccountsTable tbody');
      if (d.ok && d.accounts?.length) {
        tbody.innerHTML = d.accounts.map(a => `
          <tr><td><strong>@${a.username}</strong></td><td>${new Date(a.created_at).toLocaleDateString('sq-AL')}</td><td>${a.last_sync_at ? new Date(a.last_sync_at).toLocaleString('sq-AL') : '-'}</td><td><button class="btn btn-sm btn-outline-danger" onclick="delIgAccount(${a.id})">Hiq</button></td></tr>
        `).join('');
      } else tbody.innerHTML = '<tr><td colspan="4">Ende nuk ka llogari.</td></tr>';
    }

    async function delIgAccount(id) {
      if (!confirm('TÃ« hiqet kjo llogari?')) return;
      await api('/api/admin/instagram/accounts/' + id, { method: 'DELETE' });
      loadIgAccounts();
    }

    async function delAllowedEmail(id) {
      if (!confirm('TÃ« hiqet ky email?')) return;
      await api('/api/admin/allowed-emails/' + id, { method: 'DELETE' });
      loadData();
    }

    async function loadData() {
      await handleIgCallback();
      const [fbRes, setRes, contentRes, usersRes, allowedRes] = await Promise.all([
        api('/api/admin/feedback'),
        api('/api/admin/settings'),
        api('/api/admin/content'),
        api('/api/admin/users'),
        api('/api/admin/allowed-emails')
      ]);
      const fb = await fbRes.json();
      const set = await setRes.json();
      const content = await contentRes.json();
      const users = await usersRes.json();
      const allowed = await allowedRes.json();

      if (fb.ok) {
        document.getElementById('statLikes').textContent = fb.stats?.find(s => s.rating === 1)?.c || 0;
        document.getElementById('statDislikes').textContent = fb.stats?.find(s => s.rating === -1)?.c || 0;
        document.getElementById('statTotal').textContent = fb.feedback?.length || 0;
        const tbody = document.querySelector('#feedbackTable tbody');
        tbody.innerHTML = (fb.feedback || []).slice(0, 20).map(f =>
          `<tr><td>${new Date(f.created_at).toLocaleString('sq-AL')}</td><td>${f.rating === 1 ? 'ğŸ‘' : 'ğŸ‘'}</td><td>${f.email || '-'}</td><td>${(f.comment || '').slice(0, 50)}</td></tr>`
        ).join('');
      }

      if (set.ok) {
        document.querySelectorAll('.toggle-switch').forEach(el => {
          const key = el.dataset.key;
          const val = set.settings?.[key];
          el.checked = val !== '0' && val !== undefined;
          el.onchange = () => {
            const newVal = el.checked ? '1' : '0';
            api('/api/admin/settings', { method: 'PUT', body: JSON.stringify({ key, value: newVal }) }).then(() => {});
          };
        });
      }

      if (content.ok) {
        const logoItem = (content.content || []).find(c => c.key === 'logo_url');
        const logoInput = document.getElementById('logoUrl');
        if (logoInput) logoInput.value = logoItem?.value || set.settings?.app_logo_url || '';
      }

      if (users.ok) {
        document.querySelector('#usersTable tbody').innerHTML = (users.users || []).map(u =>
          `<tr><td>${u.id}</td><td>${u.email}</td><td>${u.name || '-'}</td><td>${u.is_admin ? 'âœ“' : '-'}</td><td>${new Date(u.created_at).toLocaleDateString('sq-AL')}</td></tr>`
        ).join('');
      }
      if (allowed.ok) {
        const tbody = document.querySelector('#allowedEmailsTable tbody');
        tbody.innerHTML = allowed.emails?.length ? allowed.emails.map(e =>
          `<tr><td>${e.email}</td><td>${new Date(e.created_at).toLocaleDateString('sq-AL')}</td><td><button class="btn btn-sm btn-outline-danger" onclick="delAllowedEmail(${e.id})">Hiq</button></td></tr>`
        ).join('') : '<tr><td colspan="3">Ende nuk ka email tÃ« lejuar.</td></tr>';
      }
      loadIgAccounts();
    }

    document.getElementById('addAllowedEmail')?.addEventListener('click', async () => {
      const input = document.getElementById('allowedEmailInput');
      const email = (input?.value || '').trim();
      if (!email || !email.includes('@')) { alert('Vendosni email tÃ« vlefshÃ«m'); return; }
      const r = await api('/api/admin/allowed-emails', { method: 'POST', body: JSON.stringify({ email }) });
      const d = await r.json();
      if (d.ok) { input.value = ''; loadData(); }
      else alert(d.error || 'Gabim');
    });

    document.getElementById('saveLogo')?.addEventListener('click', async () => {
      const url = document.getElementById('logoUrl').value.trim();
      if (!url) { alert('Vendosni URL pÃ«r logo'); return; }
      await api('/api/admin/content', { method: 'POST', body: JSON.stringify({ type: 'custom', key: 'logo_url', value: url }) });
      await api('/api/admin/settings', { method: 'PUT', body: JSON.stringify({ key: 'app_logo_url', value: url }) });
      alert('Logo u ruajt');
      loadData();
    });

    document.getElementById('uploadBtn')?.addEventListener('click', async () => {
      const file = document.getElementById('fileUpload').files[0];
      if (!file) { document.getElementById('uploadResult').textContent = 'Zgjidhni njÃ« skedar'; return; }
      const fd = new FormData();
      fd.append('file', file);
      const r = await fetch(BACKEND + '/api/admin/upload', { method: 'POST', headers: token ? { Authorization: 'Bearer ' + token } : {}, body: fd });
      const d = await r.json();
      const resultEl = document.getElementById('uploadResult');
      resultEl.textContent = d.ok ? 'U ngarkua: ' + d.url : (d.error || 'Gabim');
      if (d.ok) {
        document.getElementById('fileUpload').value = '';
        document.getElementById('logoUrl').value = d.url.startsWith('http') ? d.url : (BACKEND + d.url);
      }
    });

    checkAuth();
  </script>
</body>
</html>
