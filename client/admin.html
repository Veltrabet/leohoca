<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeoGPT - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=2.0">
  <style>
    .admin { max-width: 900px; margin: 0 auto; padding: 1.5rem; }
    .admin h1 { margin-bottom: 1.5rem; }
    .admin-section { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid var(--border); }
    .admin-section h2 { font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary); }
    .feature-toggle { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .feature-toggle:last-child { border-bottom: none; }
    .toggle-switch { width: 44px; height: 24px; background: var(--bg-elevated); border-radius: 12px; position: relative; cursor: pointer; transition: background 0.2s; }
    .toggle-switch.on { background: var(--success); }
    .toggle-switch::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: left 0.2s; }
    .toggle-switch.on::after { left: 23px; }
    .content-item { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .content-item input { flex: 1; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text-primary); }
    .content-item button { padding: 0.5rem 0.75rem; border-radius: 6px; border: none; background: #ef4444; color: white; cursor: pointer; font-size: 0.85rem; }
    .btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600; }
    .btn:hover { background: var(--accent-hover); }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .stat-box { background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-box .num { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
    .stat-box .label { font-size: 0.75rem; color: var(--text-muted); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
    .login-box { max-width: 400px; margin: 4rem auto; padding: 2rem; background: var(--bg-card); border-radius: 12px; }
    .login-box input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--border); }
    .login-box button { width: 100%; padding: 0.9rem; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
    .error { color: #ef4444; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="admin" id="adminApp">
    <div id="loginView" class="login-box" style="display:none">
      <h2>Admin GiriÅŸi</h2>
      <p class="error" id="loginErr"></p>
      <input type="email" id="adminEmail" placeholder="Email" />
      <input type="password" id="adminPassword" placeholder="Åifre" />
      <button id="adminLoginBtn">GiriÅŸ</button>
      <p style="margin-top:1rem; font-size:0.9rem"><a href="index.html" style="color:var(--accent)">â† Uygulamaya dÃ¶n</a></p>
    </div>
    <div id="dashboardView" style="display:none">
      <h1>LeoGPT Admin Panel</h1>
      <p style="margin-bottom:1.5rem; color:var(--text-secondary)">HoÅŸ geldin, <span id="adminUser"></span> | <a href="index.html" style="color:var(--accent)">Uygulama</a> | <button class="btn" id="logoutAdmin" style="margin-left:0.5rem">Ã‡Ä±kÄ±ÅŸ</button></p>

      <div class="admin-section">
        <h2>ğŸ“Š Geri Bildirim Ä°statistikleri</h2>
        <div class="stats">
          <div class="stat-box"><div class="num" id="statLikes">0</div><div class="label">BeÄŸeni ğŸ‘</div></div>
          <div class="stat-box"><div class="num" id="statDislikes">0</div><div class="label">BeÄŸenmeme ğŸ‘</div></div>
          <div class="stat-box"><div class="num" id="statTotal">0</div><div class="label">Toplam</div></div>
        </div>
        <details>
          <summary style="cursor:pointer; margin-bottom:0.5rem">Son geri bildirimler</summary>
          <div style="max-height:200px; overflow-y:auto">
            <table id="feedbackTable"><thead><tr><th>Tarih</th><th>Rating</th><th>KullanÄ±cÄ±</th><th>Yorum</th></tr></thead><tbody></tbody></table>
          </div>
        </details>
      </div>

      <div class="admin-section">
        <h2>âš™ï¸ Ã–zellik AÃ§ma/Kapama</h2>
        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem">Bu Ã¶zellikler ileride persona'ya yansÄ±yacak. Åimdilik ayar olarak kaydediliyor.</p>
        <div class="feature-toggle"><span>Ses Ã¶zellikleri</span><div class="toggle-switch" id="feat_voice" data-key="features_voice"></div></div>
        <div class="feature-toggle"><span>Sohbet Ã¶zellikleri</span><div class="toggle-switch" id="feat_chat" data-key="features_chat"></div></div>
        <div class="feature-toggle"><span>GÃ¶rsel Ã¶zellikler</span><div class="toggle-switch" id="feat_visual" data-key="features_visual"></div></div>
        <div class="feature-toggle"><span>Teknik destek</span><div class="toggle-switch" id="feat_tech" data-key="features_tech"></div></div>
        <div class="feature-toggle"><span>Ä°ÅŸ & giriÅŸim</span><div class="toggle-switch" id="feat_business" data-key="features_business"></div></div>
        <div class="feature-toggle"><span>GiriÅŸ zorunlu</span><div class="toggle-switch" id="feat_login" data-key="require_login"></div></div>
      </div>

      <div class="admin-section">
        <h2>ğŸ–¼ Logo</h2>
        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem">Uygulama logosu. Tam URL veya yÃ¼klediÄŸiniz resmin yolu.</p>
        <div class="content-item">
          <input type="text" id="logoUrl" placeholder="https://... veya /uploads/xxx.png" style="flex:2" />
          <button class="btn" id="saveLogo">Logo Kaydet</button>
        </div>
        <div id="contentList" style="margin-top:1rem"></div>
      </div>

      <div class="admin-section">
        <h2>ğŸ“¤ Resim YÃ¼kle</h2>
        <input type="file" id="fileUpload" accept="image/*" />
        <button class="btn" id="uploadBtn" style="margin-top:0.5rem">YÃ¼kle</button>
        <p id="uploadResult" style="margin-top:0.5rem; font-size:0.9rem"></p>
      </div>

      <div class="admin-section">
        <h2>ğŸ‘¥ KullanÄ±cÄ±lar</h2>
        <table id="usersTable"><thead><tr><th>ID</th><th>Email</th><th>Ad</th><th>Admin</th><th>KayÄ±t</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
  <script src="config.js"></script>
  <script>
    const BACKEND = (typeof LEOHOCA_BACKEND !== 'undefined' && LEOHOCA_BACKEND) ? LEOHOCA_BACKEND.replace(/\/$/, '') : (localStorage.getItem('leohoca_backend') || location.origin);
    let token = localStorage.getItem('leogpt_token');

    function api(path, opts = {}) {
      return fetch(BACKEND + path, {
        ...opts,
        headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}), ...opts.headers }
      });
    }

    function showLogin() {
      document.getElementById('loginView').style.display = 'block';
      document.getElementById('dashboardView').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'block';
      loadData();
    }

    async function checkAuth() {
      if (!token) { showLogin(); return; }
      const r = await api('/api/admin/check');
      const d = await r.json();
      if (d.ok && d.admin) {
        const user = JSON.parse(localStorage.getItem('leogpt_user') || '{}');
        document.getElementById('adminUser').textContent = user.email || 'Admin';
        showDashboard();
      } else showLogin();
    }

    document.getElementById('adminLoginBtn')?.addEventListener('click', async () => {
      const err = document.getElementById('loginErr');
      err.textContent = '';
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      if (!email || !password) { err.textContent = 'Email ve ÅŸifre girin'; return; }
      const r = await fetch(BACKEND + '/api/auth/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const d = await r.json();
      if (d.ok && d.user?.is_admin) {
        token = d.token;
        localStorage.setItem('leogpt_token', token);
        localStorage.setItem('leogpt_user', JSON.stringify(d.user));
        showDashboard();
      } else err.textContent = d.error || 'Yetkisiz - Admin hesabÄ± gerekli';
    });

    document.getElementById('logoutAdmin')?.addEventListener('click', () => {
      localStorage.removeItem('leogpt_token');
      localStorage.removeItem('leogpt_user');
      token = null;
      showLogin();
    });

    async function loadData() {
      const [fbRes, setRes, contentRes, usersRes] = await Promise.all([
        api('/api/admin/feedback'),
        api('/api/admin/settings'),
        api('/api/admin/content'),
        api('/api/admin/users')
      ]);
      const fb = await fbRes.json();
      const set = await setRes.json();
      const content = await contentRes.json();
      const users = await usersRes.json();

      if (fb.ok) {
        const likes = (fb.stats?.find(s => s.rating === 1)?.c || 0);
        const dislikes = (fb.stats?.find(s => s.rating === -1)?.c || 0);
        document.getElementById('statLikes').textContent = likes;
        document.getElementById('statDislikes').textContent = dislikes;
        document.getElementById('statTotal').textContent = (fb.feedback?.length || 0);
        const tbody = document.querySelector('#feedbackTable tbody');
        tbody.innerHTML = (fb.feedback || []).slice(0, 20).map(f => 
          `<tr><td>${new Date(f.created_at).toLocaleString()}</td><td>${f.rating === 1 ? 'ğŸ‘' : 'ğŸ‘'}</td><td>${f.email || '-'}</td><td>${(f.comment || '').slice(0, 50)}</td></tr>`
        ).join('');
      }

      if (set.ok) {
        document.querySelectorAll('.toggle-switch').forEach(el => {
          const key = el.dataset.key;
          const val = set.settings?.[key];
          el.classList.toggle('on', val !== '0' && val !== undefined);
          el.onclick = () => {
            const newVal = el.classList.toggle('on') ? '1' : '0';
            api('/api/admin/settings', { method: 'PUT', body: JSON.stringify({ key, value: newVal }) }).then(() => {});
          };
        });
      }

      if (content.ok) {
        const logoItem = (content.content || []).find(c => c.key === 'logo_url');
        const logoInput = document.getElementById('logoUrl');
        if (logoInput) logoInput.value = logoItem?.value || set.settings?.app_logo_url || '';
      }

      if (users.ok) {
        document.querySelector('#usersTable tbody').innerHTML = (users.users || []).map(u =>
          `<tr><td>${u.id}</td><td>${u.email}</td><td>${u.name || '-'}</td><td>${u.is_admin ? 'âœ“' : '-'}</td><td>${new Date(u.created_at).toLocaleDateString()}</td></tr>`
        ).join('');
      }
    }

    async function delContent(type, key) {
      await api(`/api/admin/content/${type}/${key}`, { method: 'DELETE' });
      loadData();
    }

    document.getElementById('saveLogo')?.addEventListener('click', async () => {
      const url = document.getElementById('logoUrl').value.trim();
      if (!url) { alert('Logo URL girin'); return; }
      await api('/api/admin/content', { method: 'POST', body: JSON.stringify({ type: 'custom', key: 'logo_url', value: url }) });
      await api('/api/admin/settings', { method: 'PUT', body: JSON.stringify({ key: 'app_logo_url', value: url }) });
      alert('Logo kaydedildi');
      loadData();
    });

    document.getElementById('uploadBtn')?.addEventListener('click', async () => {
      const file = document.getElementById('fileUpload').files[0];
      if (!file) { document.getElementById('uploadResult').textContent = 'Dosya seÃ§in'; return; }
      const fd = new FormData();
      fd.append('file', file);
      const r = await fetch(BACKEND + '/api/admin/upload', {
        method: 'POST',
        headers: token ? { Authorization: 'Bearer ' + token } : {},
        body: fd
      });
      const d = await r.json();
      const resultEl = document.getElementById('uploadResult');
      resultEl.textContent = d.ok ? 'YÃ¼klendi: ' + d.url : (d.error || 'Hata');
      if (d.ok) {
        document.getElementById('fileUpload').value = '';
        document.getElementById('logoUrl').value = d.url.startsWith('http') ? d.url : (BACKEND + d.url);
      }
    });

    checkAuth();
  </script>
</body>
</html>
